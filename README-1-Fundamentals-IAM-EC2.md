# Fundamentals - IAM & EC2

## Regions and zones

[Regions and Availability Zones](https://aws.amazon.com/about-aws/global-infrastructure/regions_az/)

* Regions
  - example: eu-west-1
  - most services run within a region
  - some are region independent (IAM, S3, cost manager, billing, quotas etc.)
* Availability Zones (AZ)
  - example: eu-west-1a
  - physical data center
  - up to 6 per region
  - AZs in the same are region are witin 100km of each other
  - low latency, sufficient for synchronous replication between AZs

## IAM

[Identity and Access Management](https://aws.amazon.com/iam/)

* Users
* Groups
* Roles (used in AWS services and resources)
* Permissions are governed by Policies
  * Written in JSON
  * Predefined 'management policies'
* [Best practices](https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html)
* [IAM federation](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers.html) is all about
  * [Integrating Third-Party SAML Solution Providers with AWS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_saml_3rd-party.html), for instance
  * [Okta](https://help.okta.com/en/prod/Content/Topics/DeploymentGuides/AWS/aws-deployment.htm)
  * [OneLogin](https://www.onelogin.com/partners/technology-partners/aws)
* Do not use the same role for more than 1 application
* Use the root account _only_ for initial setup!

## EC2

[Elastic Compute Cloud](https://docs.aws.amazon.com/ec2/index.html) (EC2)
* [Elastic Load Balancing](https://docs.aws.amazon.com/autoscaling/ec2/userguide/what-is-amazon-ec2-auto-scaling.html) (ELB)
* [Elastic Block Storage](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AmazonEBS.html) (EBS)
* [Auto Scaling](https://docs.aws.amazon.com/autoscaling/ec2/userguide/what-is-amazon-ec2-auto-scaling.html) (ASG)

Options when configuring an EC2 instance:
* [Spot Instance](https://aws.amazon.com/ec2/spot/) (save <=90% on flexible interuption-tolerant apps)
* Public IP address from Amazon's IP address pool (dynamic) vs [Elastic IP address](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html) (EIP) (fixed)
* [Subnet](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Subnets.html)
* An EC2 instance has at least one EBS volume (the root volume). You can configure  [automatic deletion of EBS volumes](https://aws.amazon.com/premiumsupport/knowledge-center/deleteontermination-ebs/) on EC2 instance termination.
* On launching the new EC2 instance, you will be asked to select or [generate a new keypair](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html) needed when [connecting to your EC2 instance](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AccessingInstances.html) over SSH.

### SSH into EC2 instance

Store the private key (`*.pem`) generated by AWS on your local machine:

```shell
~/.ssh$ ls -las
8 -rw-r--r--@  1 roelfie  staff  1696 Feb 27 13:04 Udemy-EC2-instance-1.pem
```

By default, all users have read access to the private key (`-rw-r--r--` or `0644` in [octal notation](https://en.wikipedia.org/wiki/File_system_permissions#Numeric_notation)). You can't use it to ssh into the EC2 instance:

```
 ~/.ssh$ ssh -i Udemy-EC2-instance-1.pem ec2-user@192.168.0.1
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@         WARNING: UNPROTECTED PRIVATE KEY FILE!          @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
Permissions 0644 for 'Udemy-EC2-instance-1.pem' are too open.
It is required that your private key files are NOT accessible by others.
This private key will be ignored.
Load key "Udemy-EC2-instance-1.pem": bad permissions
```

Give only the current user read access: `chmod 0400 Udemy-EC2-instance-1.pem`.

Now you can ssh into the EC2 instance (note that you have to use the `ec2-user`):
```
$ ssh -i Udemy-EC2-instance-1.pem ec2-user@192.168.0.1
```

### Security Groups

[Security groups](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-security-groups.html) control inbound and outbound traffic into EC2 instances.
* Acts as a firewall outside the EC2 instance
* Can be attached to multiple EC2 instances
* Are tied to a region / VPC; if you move an instance to another region you have to recreated your security groups.
* Default: all inbound traffic blocked, all outbound traffic open

### Elastic IP 

* If you use IP addresses from AWS' public IP address pool, the public IP address may change between EC2 instance restarts.
* If you need a fixed public IPv4 address, use Elastic IP.
* Can be attached to one EC2 instance at a time.
* Max. 5 per account.
* Try not to use elastic IPs. Use a random IP address and register a DNS name to it.
* Or even better, use a load balancer and no public IP at all.

### EC2 User Data

A [user data](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html) script is used to bootstrap an EC2 instance (like download & install software). It is run by root user and only executed on an instance's first boot.

### Launch modes

* [**On Demand**](https://aws.amazon.com/ec2/pricing/on-demand/)
  * Pay-as-you-go (billing per second)
  * No long-term commitment
  * Use cases:
    * Short-term, uninterrupted workloads
    * Auto-scaling situations (no commitment, so instance can be terminated instantly)
* [**Reserved**](https://aws.amazon.com/ec2/pricing/reserved-instances/buyer/)
  * Upfront payment (cheaper) or per hour
  * Up to 75% discount (compared to on-demand)
  * Long-term commitment (1-12 months / 12-36 months)
  * Use cases:
    * Steady state apps (like databases)
  * Special type: **Convertible Reserved Instance**
    * Up to 54% discount
    * EC instance type can be converted
  * Special type: **Scheduled Reserved Instance**
    * Launch within reserved time window
* [**Dedicated host**](https://aws.amazon.com/ec2/dedicated-hosts/getting-started/)
  * Physical EC2 server for your account only
  * Full control over EC2 instance placement
  * Allocated to your account for 3 years
  * Use cases:
    * Software with complicated license models
    * Companies with strong regulatory needs
* **Dedicated instance**
  * Physical EC2 server for your count only
  * No control over instance placement; restart may place it on another server
  * [Comparison to dedicated host](https://aws.amazon.com/ec2/dedicated-hosts/)
* [**Spot instance**](https://aws.amazon.com/aws-cost-management/aws-cost-optimization/spot-instances/)
  * Up to 90% discount (compared to on-demand)
  * Bid prices; prices varies on supply and demand
  * Reclaimed within 2 minute notification warning if spot price goes beyond your bid
  * Use for
    * Batch jobs
    * Big data analysis
    * Workloads resilient to failures
    * _Not_ for critical jobs, databases, etc.

### More EC2 facts

#### Pricing
* EC2 prices vary per region, instance type, launch mode, OS, ..
* Billing per second (minimum fee of 60 seconds)
* Possible additional costs: storage, data transfer, fixed IP, load balancing
* No costs if instance is stopped

#### [Amazon Machine Image](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html) (AMI)
* [Instances vs. AMIs](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instances-and-amis.html)
* When you create a new EC2 instance, you can choose from Amazon's list of existing AMIs
* AMIs are always built for a specific AWS region!
* Custom AMIs
  * Possible for Linux or Windows
  * Use cases:
    * Pre-installed software (hence faster boot time)
    * Pre-configured monitoring / enterprise software
    * Control of maintenance and updates
    * Active Directory integration out of the box, ..

#### Instance types

An EC2 [instance type](https://aws.amazon.com/ec2/instance-types/) is comprised of the following characteristics:
1. RAM
2. CPU
3. I/O
4. Network (bandwidth, latency)
5. GPU

When [looking for an instance type](https://ec2instances.info/), you can specifically look for memory optimized types, compute optimized, storage optimized, etc.

An instance type includes one or more instance sizes, allowing you to scale resources within an instance type.

* M-instance types are balanced (general purpose)
* T2/T3 are [burstable instances](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/burstable-performance-instances.html)
  * If your CPU 'bursts' it costs CPU credit. If you use up a lot of CPU credit, the CPU will start underperforming.
  * Burstable performance instances in [unlimited mode](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/burstable-performance-instances-unlimited-mode.html) come with unlimited burst credit balance (but come at a (high) cost)
