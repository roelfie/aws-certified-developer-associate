# Fundamentals

## Regions and zones

[Regions and Availability Zones](https://aws.amazon.com/about-aws/global-infrastructure/regions_az/)

* Regions
  - example: eu-west-1
  - most services run within a region
  - some are region independent (IAM, S3, cost manager, billing, quotas etc.)
* Availability Zones (AZ)
  - example: eu-west-1a
  - physical data center
  - up to 6 per region
  - AZs in the same are region are witin 100km of each other
  - low latency, sufficient for synchronous replication between AZs

## IAM

[Identity and Access Management](https://aws.amazon.com/iam/)

* Users
* Groups
* Roles (used in AWS services and resources)
* Permissions are governed by Policies
  * Written in JSON
  * Predefined 'management policies'
* [Best practices](https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html)
* [IAM federation](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers.html) is all about
  * [Integrating Third-Party SAML Solution Providers with AWS](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_saml_3rd-party.html), for instance
  * [Okta](https://help.okta.com/en/prod/Content/Topics/DeploymentGuides/AWS/aws-deployment.htm)
  * [OneLogin](https://www.onelogin.com/partners/technology-partners/aws)
* Do not use the same role for more than 1 application
* Use the root account _only_ for initial setup!

## EC2

[Elastic Compute Cloud](https://docs.aws.amazon.com/ec2/index.html) (EC2)
* [Elastic Load Balancing](https://docs.aws.amazon.com/autoscaling/ec2/userguide/what-is-amazon-ec2-auto-scaling.html) (ELB)
* [Elastic Block Storage](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AmazonEBS.html) (EBS)
* [Auto Scaling](https://docs.aws.amazon.com/autoscaling/ec2/userguide/what-is-amazon-ec2-auto-scaling.html) (ASG)

Options when configuring an EC2 instance:
* [Spot Instance](https://aws.amazon.com/ec2/spot/) (save <=90% on flexible interuption-tolerant apps)
* Public IP address from Amazon's IP address pool (dynamic) vs [Elastic IP address](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html) (EIP) (fixed)
* [Subnet](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Subnets.html)
* An EC2 instance has at least one EBS volume (the root volume). You can configure  [automatic deletion of EBS volumes](https://aws.amazon.com/premiumsupport/knowledge-center/deleteontermination-ebs/) on EC2 instance termination.
* On launching the new EC2 instance, you will be asked to select or [generate a new keypair](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html) needed when [connecting to your EC2 instance](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AccessingInstances.html) over SSH.

### SSH into EC2 instance

Store the private key (`*.pem`) generated by AWS on your local machine:

```shell
~/.ssh$ ls -las
8 -rw-r--r--@  1 roelfie  staff  1696 Feb 27 13:04 Udemy-EC2-instance-1.pem
```

By default, all users have read access to the private key (`-rw-r--r--` or `0644` in [octal notation](https://en.wikipedia.org/wiki/File_system_permissions#Numeric_notation)). You can't use it to ssh into the EC2 instance:

```
 ~/.ssh$ ssh -i Udemy-EC2-instance-1.pem ec2-user@192.168.0.1
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@         WARNING: UNPROTECTED PRIVATE KEY FILE!          @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
Permissions 0644 for 'Udemy-EC2-instance-1.pem' are too open.
It is required that your private key files are NOT accessible by others.
This private key will be ignored.
Load key "Udemy-EC2-instance-1.pem": bad permissions
```

Give only the current user read access: `chmod 0400 Udemy-EC2-instance-1.pem`.

Now you can ssh into the EC2 instance (note that you have to use the `ec2-user`):
```
$ ssh -i Udemy-EC2-instance-1.pem ec2-user@192.168.0.1
```

### Security Groups

[Security groups](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-security-groups.html) control inbound and outbound traffic into EC2 instances.
* Acts as a firewall outside the EC2 instance
* Can be attached to multiple EC2 instances
* Are tied to a region / VPC; if you move an instance to another region you have to recreated your security groups.
* Default: all inbound traffic blocked, all outbound traffic open

### Elastic IP 

* If you use IP addresses from AWS' public IP address pool, the public IP address may change between EC2 instance restarts.
* If you need a fixed public IPv4 address, use Elastic IP.
* Can be attached to one EC2 instance at a time.
* Max. 5 per account.
* Try not to use elastic IPs. Use a random IP address and register a DNS name to it.
* Or even better, use a load balancer and no public IP at all.

### EC2 User Data

A [user data](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html) script is used to bootstrap an EC2 instance (like download & install software). It is run by root user and only executed on an instance's first boot.

### Launch modes

* [**On Demand**](https://aws.amazon.com/ec2/pricing/on-demand/)
  * Pay-as-you-go (billing per second)
  * No long-term commitment
  * Use cases:
    * Short-term, uninterrupted workloads
    * Auto-scaling situations (no commitment, so instance can be terminated instantly)
* [**Reserved**](https://aws.amazon.com/ec2/pricing/reserved-instances/buyer/)
  * Upfront payment (cheaper) or per hour
  * Up to 75% discount (compared to on-demand)
  * Long-term commitment (1-12 months / 12-36 months)
  * Use cases:
    * Steady state apps (like databases)
  * Special type: **Convertible Reserved Instance**
    * Up to 54% discount
    * EC instance type can be converted
  * Special type: **Scheduled Reserved Instance**
    * Launch within reserved time window
* [**Dedicated host**](https://aws.amazon.com/ec2/dedicated-hosts/getting-started/)
  * Physical EC2 server for your account only
  * Full control over EC2 instance placement
  * Allocated to your account for 3 years
  * Use cases:
    * Software with complicated license models
    * Companies with strong regulatory needs
* **Dedicated instance**
  * Physical EC2 server for your count only
  * No control over instance placement; restart may place it on another server
  * [Comparison to dedicated host](https://aws.amazon.com/ec2/dedicated-hosts/)
* [**Spot instance**](https://aws.amazon.com/aws-cost-management/aws-cost-optimization/spot-instances/)
  * Up to 90% discount (compared to on-demand)
  * Bid prices; prices varies on supply and demand
  * Reclaimed within 2 minute notification warning if spot price goes beyond your bid
  * Use for
    * Batch jobs
    * Big data analysis
    * Workloads resilient to failures
    * _Not_ for critical jobs, databases, etc.

### More EC2 facts

#### Pricing
* EC2 prices vary per region, instance type, launch mode, OS, ..
* Billing per second (minimum fee of 60 seconds)
* Possible additional costs: storage, data transfer, fixed IP, load balancing
* No costs if instance is stopped

#### [Amazon Machine Image](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html) (AMI)
* [Instances vs. AMIs](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instances-and-amis.html)
* When you create a new EC2 instance, you can choose from Amazon's list of existing AMIs
* AMIs are always built for a specific AWS region!
* Custom AMIs
  * Possible for Linux or Windows
  * Use cases:
    * Pre-installed software (hence faster boot time)
    * Pre-configured monitoring / enterprise software
    * Control of maintenance and updates
    * Active Directory integration out of the box, ..

#### Instance types

An EC2 [instance type](https://aws.amazon.com/ec2/instance-types/) is comprised of the following characteristics:
1. RAM
2. CPU
3. I/O
4. Network (bandwidth, latency)
5. GPU

When [looking for an instance type](https://ec2instances.info/), you can specifically look for memory optimized types, compute optimized, storage optimized, etc.

An instance type includes one or more instance sizes, allowing you to scale resources within an instance type.

* M-instance types are balanced (general purpose)
* T2/T3 are [burstable instances](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/burstable-performance-instances.html)
  * If your CPU 'bursts' it costs CPU credit. If you use up a lot of CPU credit, the CPU will start underperforming.
  * Burstable performance instances in [unlimited mode](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/burstable-performance-instances-unlimited-mode.html) come with unlimited busrt credit balance (but come at a (high) cost)

## [Elastic Load Balancing](https://aws.amazon.com/elasticloadbalancing/) (ELB)

Functions of the 
* Distribute traffic across multiple targets
* [Health check](https://docs.aws.amazon.com/autoscaling/ec2/userguide/healthcheck.html) downstream instances
* [SSL termination](https://avinetworks.com/glossary/ssl-termination/) (encryption / decryption)
* [Sticky sessions](https://docs.aws.amazon.com/elasticloadbalancing/latest/classic/elb-sticky-sessions.html)
* High availability across AZs
* Separate public traffic from private traffic

### [Types of load balancers](https://aws.amazon.com/elasticloadbalancing/features/)

|                                   | Application Load Balancer  | Network Load Balancer  | Classic Load Balancer      |
|-----------------------------------|----------------------------|------------------------|----------------------------|
| Layer                             | Layer 7 (application)      | Layer 4 (transport)    |                            |
| Since                             | 2016                       | 2017                   | 2009                       |
| Protocols                         | HTTP, HTTPS                | TCP, UDP, TLS          | TCP, SSL/TLS, HTTP, HTTPS  |
| Websockets                        | v                          | v                      | v                          |
| IP address as target              | v                          | v                      |                            |
| Sticky sessions                   | v                          |                        | v                          |
| Static IP                         |                            | v                      |                            |
| Elastic IP                        |                            | v                      |                            |
| Redirects                         | v                          |                        |                            |
| Fixed response                    | v                          |                        |                            |
| Lambda function as target         | v                          |                        |                            |
| **Content-based routing**         |                            |                        |                            |
| Path-based routing                | v                          |                        |                            |
| Host-based routing                | v                          |                        |                            |
| HTTP header-based routing         | v                          |                        |                            |
| HTTP method-based routing         | v                          |                        |                            |
| Query string param-based routing  | v                          |                        |                            |
| Source IP addr CIDR-based routing | v                          |                        |                            |
| **Security**                      |                            |                        |                            |
| Tag-based IAM permissions         | v                          | v                      |                            |
| Resource-based IAM permissions    | v                          | v                      | v                          |
| User Authentication               | v                          |                        |                            |

All load balancers support
* SSL or TLS (SSL offloading)
* Health checks
* CloudWatch metrics
* Logging
* Zonal fail-over
* Cross zone load balancing

:warning: All LBs have a static host name. Do never use the underlying IP address!

:warning: LBs can scal, but not instantaneously (contact AWS for a "warm up" if needed)

:warning: HTTP 503 means either no target, or LB has no more capacity

Elastic Load Balancing [User Guide](https://docs.aws.amazon.com/elasticloadbalancing/latest/userguide/what-is-load-balancing.html#elb-features)

[Target groups](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-target-groups.html)

#### [Application Load Balancer](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/introduction.html)
* Content-based routing rules (See table above)
* Latency 400ms
* Load balancer sets the following HTTP headers:
  * `X-Forwarded-For`: Client IP address
  * `X-Forwarded-Port`: Destination port the client used to connect to the LB
  * `X-Forwarded-Proto`: Protocol the client used to connect to the LB (HTTP or HTTPS)
* Request tracing (load balancer injects a `X-Amzn-Trace-Id` HTTP header)
* Balancing across machines
* Balancing across containers (applications on the same machine)
* Good for: Microservices & container based applications (docker, Amazon ECS)
* Port mapping feature to map to dynamic port
* SSL certificate management (through IAM and AWS Certificate Management)

#### [Network Load Balancer](https://docs.aws.amazon.com/elasticloadbalancing/latest/network/introduction.html)
* High performance (millions requests/sec) and ultra-low latency (100ms)
* Handles sudden and volatile traffic patterns
* Integrated with AutoScaling, EC2, Cloud Formation and AWS Certificate Management (ACM)
* Work with: EC2 instances, microservices, containers

#### [Classic Load Balancer](https://docs.aws.amazon.com/elasticloadbalancing/latest/classic/introduction.html) (deprecated)
* Only recommended for applications built within the EC2-Classic network.

### Application Load Balancer configuration for EC2 instances

Example of an AWS EC2 configuration with two instances hosting a web application on port 81:

* www: HTTP request on port 80 (@load balancer DNS name)
  * (security group allowing port 80) -> Application Load Balancer
    * Target Group
      * configured to forward HTTP traffic to port 81 on EC2 instances (in specified AZs)
      * the following EC2 instances are registered in the target group:
        * (security group allowing port 81) EC2 instance 1 (AZ a)
        * (security group allowing port 81) EC2 instance 2 (AZ b)

By default an EC2 instance is given a public IP address. If you want to allow inbound traffic only via the load balancer, configure the EC2 instance's security group as follows:
* Type = Custom TCP rule
* Port range = 81 (example)
* Source
  * Custom
  * In the value you can type in the Name or Id of the load balancer's security group

### EC2 Auto Scaling

EC2 [Auto Scaling](https://docs.aws.amazon.com/autoscaling/ec2/userguide/what-is-amazon-ec2-auto-scaling.html) (ASG) allows you to ensure that you have the correct number of instances available to handle the load for your application.
* Scale out (add instance) and in (remove instance) as load changes over time
* Based on (CloudWatch) alarms
  * avg. CPU
  * avg. network I/O
  * #requests on the ELB per instance
  * custom metrics (e.g. #connected users)
    * send custom metric from EC2 application to CloudWatch
    * create CloudWatch alarm based on metric
    * use alarm as scaling policy for the ASG
* You can also autoscale based on  schedule (if you know that everyday 5-7pm are peak hrs)
* Specify minimum & maximum #instances
* Automatically register new instance with load balancer
* IAM roles defined on ASG will be inherited by the EC2 instances
* ASG is a free service (you pay for the EC2 instances)
* ASG will restart an instance if it gets terminated
* ASG will terminate an instance if it is unhealthy (and spin up a new one if necessary)

#### Creating an Auto Scaling Group (ASG)

* Create / select a launch template (AMI, user data, security group, etc.)
* Create an ASG
  * You can put your ASG behind an ELB by choosing the appropriate target group 

##### Mixing manually created and ASG created instances

:warning: If you use an existing target group, with one or more manually created EC2 instances in it, those EC2 instances will not be managed by the ASG! Suppose your target group originally already contained one EC2 instance. If you create a new ASG with this target group and tell the ASG it should have a minimum of 1 instance, then it will spin up one (additional!) EC2 instance in the target group.
* There are now 2 EC2 instances in the target group
* There is now 1 EC2 instance visible in the ASG
* The load balancer will distribute traffic to the 2 EC2 instances

Bottom line: Using a non-empty target group in a new ASG will lead to confusion.

### Elastic Block Store (EBS)

* [EBS](https://aws.amazon.com/ebs)
* Elastic Block Store [User Guide](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AmazonEBS.html)

* Network drive (not a physical drive)
* Easily detached from one instance and attached to another
* Locked to an AZ
* You can not move an ESB cross zones, but you _can_ move ESB _snapshots_
* Billing for all the provisioned capacity (GB and IOPS)
* [ESB Volume Types](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AmazonEBS.html)
  * SSD
    * gp2: general purpose, recommended for most workloads (boot volumes, virtual desktops, dev/test environments)
    * io1: critical business applications with high throughput (databases)
  * HDD (can not be boot volume)
    * st1: consistent, fast throughput at a low price (big data, data warehouse, log processing)
    * sc1: large volumes of data that is infrequently accessed, low price (backup, archiving)
* EBS Volumes can be [resized](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/requesting-ebs-volume-modifications.html) (for io1, IOPS can also be increased)
* [Snapshots](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSSnapshots.html) 
  * backups, changing volume type, volume encryption, etc.
  * smaller than the actual volume (only the actual data is in it)
  * can be scheduled (nightly backups)
* When you create an [encrypted EBS volume](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSEncryption.html)
  * All **data at rest** is encrypted inside volume
  * All **data in flight** (between EC2 instance and EBS) is also encrypted
  * All snapshots are encrypted (as are the volumes created from the snapshots)
  * Fully transparent, minimal impact on latency

#### Instance Store vs EBS

There are [two types of root volumes](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/RootDeviceStorage.html) for EC2 instances: 
* Amazon EBS volume (created from an Amazon EBS snapshot)
* [Instance store volume](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ComponentsAMIs.html#storage-for-the-root-device) (created from a template stored in Amazon S3)
  * physically attached to the EC2 instance
  * boots slower
  * better I/O
  * cannot be stopped; only running or terminated
  * instance store lost on EC2 instance termination
  * can't be resized



